<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Unit Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        kbd {
            background-color: #eee;
            border-radius: 3px;
            border: 1px solid #b4b4b4;
            box-shadow: 0 1px 1px rgba(0, 0, 0, .2), 0 2px 0 0 rgba(255, 255, 255, .7) inset;
            color: #333;
            display: inline-block;
            font-family: monospace;
            font-size: .8em;
            font-weight: 700;
            padding: 2px 4px;
            white-space: nowrap;
            margin: 0 2px;
        }
        /* Styles for the sidebar project buttons */
        .sidebar-button-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            margin-bottom: 0.5rem;
            border: 1px solid transparent;
            background-color: transparent; /* Inactive state */
            color: #374151; /* gray-700 */
        }
        .sidebar-button-container.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 600;
        }
        .sidebar-button-container:hover:not(.active) {
            background-color: #e5e7eb; /* gray-200 */
        }
        .sidebar-button-name {
            flex-grow: 1;
            text-align: left;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            font-weight: 500;
        }
        .sidebar-button-container.active .sidebar-button-name {
            color: white;
            font-weight: 600;
        }
        .rename-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            color: #9ca3af; /* gray-400 */
            flex-shrink: 0;
            margin-left: 0.5rem;
        }
        .rename-btn:hover {
            background-color: #d1d5db; /* gray-300 */
            color: #1f2937; /* gray-800 */
        }
        .sidebar-button-container.active .rename-btn {
            color: #bfdbfe; /* blue-200 */
        }
         .sidebar-button-container.active .rename-btn:hover {
            background-color: #60a5fa; /* blue-400 */
            color: white;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
    
    <!-- Mobile Menu Button -->
    <button id="menu-toggle" class="md:hidden fixed bottom-4 right-4 z-40 p-2 bg-blue-500 text-white rounded-full shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
        </svg>
    </button>
    
    <!-- Sidebar Overlay (mobile only) -->
    <div id="sidebar-overlay" class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-20 hidden"></div>

    <!-- Main container with two-column layout -->
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl border border-gray-200 flex min-h-[90vh]">

        <!-- Sidebar for Projects -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-30 w-72 bg-gray-50 p-6 flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:w-1/4 md:translate-x-0 md:border-r border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Projects</h2>
            <button id="addProjectBtn" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-2 px-4 rounded-lg shadow-sm transition duration-200 ease-in-out mb-4">
                + Add
            </button>
            <div id="projectTabsContainer" class="flex-grow">
                <!-- Project buttons will be rendered here by JavaScript -->
            </div>
        </div>
        
        <!-- Main Content Area for the Calculator -->
        <div class="w-full p-8 overflow-y-auto">
            <h1 class="text-3xl font-bold text-gray-800 text-center">Material Unit Calculator</h1>
            <h2 id="currentProjectName" class="text-xl font-semibold text-gray-500 mb-6 text-center"></h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Resins Inputs -->
                <div class="flex flex-col">
                    <label for="resinsNeeded" class="text-lg font-medium text-gray-700 mb-2">Total Resins Needed:</label>
                    <div class="flex items-center gap-2 mb-2">
                        <input type="number" id="resinsNeeded" placeholder="e.g., 200" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                        <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="resinsNeeded">+</button>
                    </div>
                    <label for="resinsHave" class="text-lg font-medium text-gray-700 mb-2">Resins You Have:</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="resinsHave" placeholder="e.g., 50" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                        <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="resinsHave">+</button>
                    </div>
                </div>

                <!-- Metals Inputs -->
                <div class="flex flex-col">
                    <label for="metalsNeeded" class="text-lg font-medium text-gray-700 mb-2">Total Metals Needed:</label>
                    <div class="flex items-center gap-2 mb-2">
                        <input type="number" id="metalsNeeded" placeholder="e.g., 550" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                        <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="metalsNeeded">+</button>
                    </div>
                    <label for="metalsHave" class="text-lg font-medium text-gray-700 mb-2">Metals You Have:</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="metalsHave" placeholder="e.g., 100" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                        <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="metalsHave">+</button>
                    </div>
                </div>

                <!-- Ceramics Inputs -->
                <div class="flex flex-col">
                    <label for="ceramicsNeeded" class="text-lg font-medium text-gray-700 mb-2">Total Ceramics Needed:</label>
                    <div class="flex items-center gap-2 mb-2">
                        <input type="number" id="ceramicsNeeded" placeholder="e.g., 350" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                        <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="ceramicsNeeded">+</button>
                    </div>
                    <label for="ceramicsHave" class="text-lg font-medium text-gray-700 mb-2">Ceramics You Have:</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="ceramicsHave" placeholder="e.g., 80" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                        <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="ceramicsHave">+</button>
                    </div>
                </div>

                <!-- Chemicals Inputs -->
                <div class="flex flex-col">
                    <label for="chemicalsNeeded" class="text-lg font-medium text-gray-700 mb-2">Total Chemicals Needed:</label>
                    <div class="flex items-center gap-2 mb-2">
                        <input type="number" id="chemicalsNeeded" placeholder="e.g., 180" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                        <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="chemicalsNeeded">+</button>
                    </div>
                    <label for="chemicalsHave" class="text-lg font-medium text-gray-700 mb-2">Chemicals You Have:</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="chemicalsHave" placeholder="e.g., 30" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                        <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="chemicalsHave">+</button>
                    </div>
                </div>

                <!-- Special Alloys Inputs -->
                <div class="flex flex-col">
                    <label for="specialAlloysNeeded" class="text-lg font-medium text-gray-700 mb-2">Total Special Alloys Needed:</label>
                    <div class="flex items-center gap-2 mb-2">
                        <input type="number" id="specialAlloysNeeded" placeholder="e.g., 700" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                        <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="specialAlloysNeeded">+</button>
                    </div>
                    <label for="specialAlloysHave" class="text-lg font-medium text-gray-700 mb-2">Special Alloys You Have:</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="specialAlloysHave" placeholder="e.g., 120" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                        <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="specialAlloysHave">+</button>
                    </div>
                </div>

                <!-- Chiral Crystals Inputs -->
                <div class="flex flex-col">
                    <label for="chiralCrystalsNeeded" class="text-lg font-medium text-gray-700 mb-2">Total Chiral Crystals Needed:</label>
                    <div class="flex items-center gap-2 mb-2">
                        <input type="number" id="chiralCrystalsNeeded" placeholder="e.g., 100" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                        <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="chiralCrystalsNeeded">+</button>
                    </div>
                    <label for="chiralCrystalsHave" class="text-lg font-medium text-gray-700 mb-2">Chiral Crystals You Have:</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="chiralCrystalsHave" placeholder="e.g., 20" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                        <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="chiralCrystalsHave">+</button>
                    </div>
                </div>
            </div>

            <button id="calculateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                Calculate Units
            </button>
            
            <button id="finishedBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg mt-4 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                Project Finished
            </button>
            
            <button id="resetBtn" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-xl shadow-lg mt-4 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-75">
                Reset needed materials
            </button>
            
            <!-- Results and Placeholder -->
            <div id="results-placeholder" class="mt-8 p-4 bg-gray-100 rounded-lg border border-gray-200 text-center text-gray-500 italic">
                Enter amounts and click "Calculate Units" to see the breakdown.
            </div>
            <div id="results-container" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                <div id="resinsResult" class="bg-blue-50 p-4 rounded-lg border border-blue-200"></div>
                <div id="metalsResult" class="bg-green-50 p-4 rounded-lg border border-green-200"></div>
                <div id="ceramicsResult" class="bg-yellow-50 p-4 rounded-lg border border-yellow-200"></div>
                <div id="chemicalsResult" class="bg-purple-50 p-4 rounded-lg border border-purple-200"></div>
                <div id="specialAlloysResult" class="bg-red-50 p-4 rounded-lg border border-red-200"></div>
                <div id="chiralCrystalsResult" class="bg-gray-50 p-4 rounded-lg border border-gray-200"></div>
            </div>

        </div>
    </div>

    <!-- Modals -->
    <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="modalMessage" class="text-gray-800 text-lg mb-4"></p>
            <button id="modalCloseBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">OK</button>
        </div>
    </div>
    <div id="addProjectModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Add New Project</h3>
            <input type="text" id="projectNameInput" placeholder="Enter project name" class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <div class="flex justify-end gap-2">
                <button id="cancelAddProjectBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="confirmAddProjectBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Save</button>
            </div>
        </div>
    </div>
    <div id="renameProjectModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Rename Project</h3>
            <input type="text" id="renameProjectInput" placeholder="Enter new project name" class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <div class="flex justify-end gap-2">
                <button id="cancelRenameProjectBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="confirmRenameProjectBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Save</button>
            </div>
        </div>
    </div>
    <div id="addAmountModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Add Amount</h3>
            <input type="number" id="amountToAddInput" placeholder="Enter amount to add" class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent" min="0">
            <div class="flex justify-end gap-2">
                <button id="cancelAddAmountBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md">Cancel</button>
                <button id="confirmAddAmountBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Add</button>
            </div>
        </div>
    </div>
    <div id="confirmFinishedModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p class="text-gray-800 text-lg mb-4">Are you sure you want to mark this project as finished? This will reset "Total Needed" and adjust "You Have" amounts.</p>
            <div class="flex justify-center gap-4">
                <button id="confirmFinishedYesBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">Yes, Finished</button>
                <button id="confirmFinishedNoBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md">No, Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global application state
        let appState = {
            projects: [],
            inventory: {
                resinsHave: 0, metalsHave: 0, ceramicsHave: 0,
                chemicalsHave: 0, specialAlloysHave: 0, chiralCrystalsHave: 0,
            },
            activeProjectIndex: 0,
            projectToRenameIndex: null, // To track which project is being renamed
        };
        
        // Helper function to convert display names to camelCase for use as keys/IDs
        const nameToCamelCase = (name) => {
            const parts = name.split(' ');
            if (parts.length === 1) return parts[0].toLowerCase();
            return parts[0].toLowerCase() + parts.slice(1).map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('');
        };

        // Function to display messages in a custom modal
        function showModalMessage(message) {
            const modal = document.getElementById('messageModal');
            const modalMessage = document.getElementById('modalMessage');
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            document.getElementById('modalCloseBtn').onclick = () => modal.classList.add('hidden');
        }

        const unitSizes = {
            resins: [320, 160, 80, 40], metals: [400, 200, 100, 50],
            ceramics: [320, 160, 80, 40], chemicals: [240, 120, 60, 30],
            specialAlloys: [480, 240, 120, 60]
        };

        function calculateUnits(totalAmount, sizes) {
            let currentTotalProvided = 0;
            const unitsBreakdown = {};
            let wasted = 0;
            for (const size of sizes) {
                if (size > 0 && currentTotalProvided < totalAmount) {
                    const count = Math.floor((totalAmount - currentTotalProvided) / size);
                    if (count > 0) {
                        unitsBreakdown[size] = (unitsBreakdown[size] || 0) + count;
                        currentTotalProvided += count * size;
                    }
                }
            }
            if (currentTotalProvided < totalAmount) {
                const smallestSize = sizes[sizes.length - 1];
                if (smallestSize > 0) {
                    unitsBreakdown[smallestSize] = (unitsBreakdown[smallestSize] || 0) + 1;
                    currentTotalProvided += smallestSize;
                }
            }
            wasted = currentTotalProvided - totalAmount;
            return { units: unitsBreakdown, wasted: Math.max(0, wasted), totalProvided: currentTotalProvided };
        }

        function formatResults(materialDisplayName, totalNeeded, totalHave, netRequired, calcResult) {
            const keyMap = { "Resins": "resins", "Metals": "metals", "Ceramics": "ceramics", "Chemicals": "chemicals", "Special Alloys": "specialAlloys" };
            const materialKey = keyMap[materialDisplayName];
            let output = `<h3 class="text-lg font-semibold text-gray-800 mb-2">${materialDisplayName}</h3>`;
            output += `<p class="text-sm text-gray-600">Total Needed: ${totalNeeded}</p>`;
            output += `<p class="text-sm text-gray-600">You Have: ${totalHave}</p>`;
            output += `<p class="text-sm font-medium text-blue-700 mb-2">Net Required: ${netRequired}</p>`;

            if (materialDisplayName !== "Chiral Crystals") {
                let hasUnits = false;
                if (!materialKey || !unitSizes[materialKey]) {
                    output += `<p class="text-red-600">Error: Could not retrieve unit sizes.</p>`;
                } else {
                    output += `<p class="text-sm font-semibold text-gray-700 mt-2">Unit Breakdown:</p>`;
                    const sizesForMaterial = unitSizes[materialKey];
                    for (const size of sizesForMaterial) {
                        const count = calcResult.units[size] || 0;
                        if (count > 0) {
                            output += `<p class="text-sm text-gray-700 ml-4">${count} x ${size} units</p>`;
                            hasUnits = true;
                        }
                    }
                    if (!hasUnits && netRequired > 0) {
                        output += `<p class="text-sm text-gray-500 ml-4">No standard units needed.</p>`;
                    } else if (netRequired <= 0) {
                        output += `<p class="text-sm text-gray-500 ml-4">Requirements met.</p>`;
                    }
                }
                if (calcResult && calcResult.wasted > 0) {
                    output += `<p class="text-sm font-medium text-red-600 mt-1">Wasted: ${calcResult.wasted}</p>`;
                }
            }
            return output;
        }

        function getMaterialInputs() {
            const materialTypes = ['resins', 'metals', 'ceramics', 'chemicals', 'specialAlloys', 'chiralCrystals'];
            return materialTypes.map(type => ({
                needed: document.getElementById(`${type}Needed`),
                have: document.getElementById(`${type}Have`),
            }));
        }

        function saveAppState() {
            localStorage.setItem('materialCalculatorAppState', JSON.stringify(appState));
        }

        function loadAppState() {
            const savedState = localStorage.getItem('materialCalculatorAppState');
            if (savedState) {
                appState = JSON.parse(savedState);
                if (!appState.projects || appState.projects.length === 0) {
                    appState.projects = [{ name: "Project 1", materials: { resinsNeeded: 0, metalsNeeded: 0, ceramicsNeeded: 0, chemicalsNeeded: 0, specialAlloysNeeded: 0, chiralCrystalsNeeded: 0 }}];
                    appState.activeProjectIndex = 0;
                }
                if (!appState.inventory) {
                    appState.inventory = { resinsHave: 0, metalsHave: 0, ceramicsHave: 0, chemicalsHave: 0, specialAlloysHave: 0, chiralCrystalsHave: 0 };
                }
                if (appState.activeProjectIndex === undefined || appState.activeProjectIndex >= appState.projects.length) {
                    appState.activeProjectIndex = 0;
                }
            } else {
                appState.projects.push({ name: "Project 1", materials: { resinsNeeded: 0, metalsNeeded: 0, ceramicsNeeded: 0, chemicalsNeeded: 0, specialAlloysNeeded: 0, chiralCrystalsNeeded: 0 }});
            }
        }

        function renderTabs() {
            const tabContainer = document.getElementById('projectTabsContainer');
            tabContainer.innerHTML = '';
            appState.projects.forEach((project, index) => {
                const container = document.createElement('div');
                container.className = 'sidebar-button-container';
                if (index === appState.activeProjectIndex) {
                    container.classList.add('active');
                }
                
                const nameButton = document.createElement('button');
                nameButton.textContent = project.name;
                nameButton.className = 'sidebar-button-name';
                nameButton.onclick = () => switchProject(index);
                
                const renameButton = document.createElement('button');
                renameButton.className = 'rename-btn';
                renameButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg>`;
                renameButton.onclick = (e) => {
                    e.stopPropagation(); // prevent switchProject from firing
                    openRenameProjectModal(index);
                };

                container.appendChild(nameButton);
                container.appendChild(renameButton);
                tabContainer.appendChild(container);
            });
        }
        
        function clearResults() {
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.classList.add('hidden');
            const placeholder = document.getElementById('results-placeholder');
            placeholder.classList.remove('hidden');
            const resultDivs = resultsContainer.querySelectorAll('div[id$="Result"]');
            resultDivs.forEach(div => {
                div.innerHTML = '';
            });
        }

        function switchProject(index) {
            if (appState.projects[appState.activeProjectIndex]) {
                 saveCurrentProjectNeeds();
            }
            appState.activeProjectIndex = index;
            loadProjectData(index);
            renderTabs();
            clearResults();
            // Close sidebar on mobile after selection
            if (window.innerWidth < 768) {
                closeSidebar();
            }
        }

        function loadProjectData(index) {
            const project = appState.projects[index];
            if (!project) return;
            document.getElementById('currentProjectName').textContent = project.name;
            getMaterialInputs().forEach(material => {
                const neededId = material.needed.id;
                const haveId = material.have.id;
                material.needed.value = project.materials[neededId] || 0;
                material.have.value = appState.inventory[haveId] || 0;
            });
        }

        function saveCurrentProjectNeeds() {
            const project = appState.projects[appState.activeProjectIndex];
            if (!project) return;
            getMaterialInputs().forEach(material => {
                project.materials[material.needed.id] = parseInt(material.needed.value) || 0;
            });
            saveAppState();
        }

        function saveInventory() {
            getMaterialInputs().forEach(material => {
                appState.inventory[material.have.id] = parseInt(material.have.value) || 0;
            });
            saveAppState();
        }

        function resetCalculator() {
            const project = appState.projects[appState.activeProjectIndex];
            Object.keys(project.materials).forEach(key => project.materials[key] = 0);
            loadProjectData(appState.activeProjectIndex);
            clearResults();
            saveAppState();
        }

        // Modal Handlers
        const addProjectModal = document.getElementById('addProjectModal');
        const projectNameInput = document.getElementById('projectNameInput');
        const confirmAddProjectBtn = document.getElementById('confirmAddProjectBtn');
        const cancelAddProjectBtn = document.getElementById('cancelAddProjectBtn');

        const renameProjectModal = document.getElementById('renameProjectModal');
        const renameProjectInput = document.getElementById('renameProjectInput');
        const confirmRenameProjectBtn = document.getElementById('confirmRenameProjectBtn');
        const cancelRenameProjectBtn = document.getElementById('cancelRenameProjectBtn');

        function openAddProjectModal() {
            projectNameInput.value = `Project ${appState.projects.length + 1}`;
            addProjectModal.classList.remove('hidden');
            projectNameInput.focus();
            projectNameInput.select();
        }

        function closeAddProjectModal() { addProjectModal.classList.add('hidden'); }

        function openRenameProjectModal(index) {
            appState.projectToRenameIndex = index;
            renameProjectInput.value = appState.projects[index].name;
            renameProjectModal.classList.remove('hidden');
            renameProjectInput.focus();
            renameProjectInput.select();
        }

        function closeRenameProjectModal() {
            renameProjectModal.classList.add('hidden');
            appState.projectToRenameIndex = null;
        }

        confirmAddProjectBtn.addEventListener('click', () => {
            const newProjectName = projectNameInput.value.trim();
            if (newProjectName) {
                appState.projects.push({ name: newProjectName, materials: { resinsNeeded: 0, metalsNeeded: 0, ceramicsNeeded: 0, chemicalsNeeded: 0, specialAlloysNeeded: 0, chiralCrystalsNeeded: 0 }});
                closeAddProjectModal();
                switchProject(appState.projects.length - 1);
            } else {
                showModalMessage("Project name cannot be empty.");
            }
        });

        confirmRenameProjectBtn.addEventListener('click', () => {
            const newName = renameProjectInput.value.trim();
            if (newName && appState.projectToRenameIndex !== null) {
                appState.projects[appState.projectToRenameIndex].name = newName;
                saveAppState();
                renderTabs();
                closeRenameProjectModal();
            } else {
                 showModalMessage("Project name cannot be empty.");
            }
        });

        cancelAddProjectBtn.addEventListener('click', closeAddProjectModal);
        cancelRenameProjectBtn.addEventListener('click', closeRenameProjectModal);

        addProjectModal.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') confirmAddProjectBtn.click();
            if (e.key === 'Escape') cancelAddProjectBtn.click();
        });
        renameProjectModal.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') confirmRenameProjectBtn.click();
            if (e.key === 'Escape') cancelRenameProjectBtn.click();
        });

        const addAmountModal = document.getElementById('addAmountModal');
        const amountToAddInput = document.getElementById('amountToAddInput');
        const confirmAddAmountBtn = document.getElementById('confirmAddAmountBtn');
        const cancelAddAmountBtn = document.getElementById('cancelAddAmountBtn');
        let currentTargetInputId = null;

        function openAddAmountModal(targetId) {
            currentTargetInputId = targetId;
            amountToAddInput.value = '';
            addAmountModal.classList.remove('hidden');
            amountToAddInput.focus();
        }

        function closeAddAmountModal() { addAmountModal.classList.add('hidden'); }

        confirmAddAmountBtn.addEventListener('click', () => {
            const targetInput = document.getElementById(currentTargetInputId);
            if (targetInput) {
                const amount = parseInt(amountToAddInput.value) || 0;
                targetInput.value = (parseInt(targetInput.value) || 0) + amount;
                targetInput.dispatchEvent(new Event('input')); // Trigger input event to save state
            }
            closeAddAmountModal();
        });

        cancelAddAmountBtn.addEventListener('click', closeAddAmountModal);

        const confirmFinishedModal = document.getElementById('confirmFinishedModal');
        document.getElementById('finishedBtn').addEventListener('click', () => confirmFinishedModal.classList.remove('hidden'));
        document.getElementById('confirmFinishedNoBtn').addEventListener('click', () => confirmFinishedModal.classList.add('hidden'));
        document.getElementById('confirmFinishedYesBtn').addEventListener('click', () => {
            const project = appState.projects[appState.activeProjectIndex];
            Object.keys(project.materials).forEach(neededKey => {
                const haveKey = neededKey.replace('Needed', 'Have');
                const needed = project.materials[neededKey] || 0;
                appState.inventory[haveKey] = Math.max(0, (appState.inventory[haveKey] || 0) - needed);
                project.materials[neededKey] = 0;
            });
            loadProjectData(appState.activeProjectIndex);
            clearResults();
            saveAppState();
            confirmFinishedModal.classList.add('hidden');
        });
        
        // Sidebar toggle logic
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        const openSidebar = () => {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
        };

        const closeSidebar = () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        };

        // Event Listeners Setup
        document.addEventListener('DOMContentLoaded', () => {
            loadAppState();
            renderTabs();
            loadProjectData(appState.activeProjectIndex);
            clearResults();
            
            menuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                if (sidebar.classList.contains('-translate-x-full')) {
                    openSidebar();
                } else {
                    closeSidebar();
                }
            });

            sidebarOverlay.addEventListener('click', closeSidebar);

            document.getElementById('addProjectBtn').addEventListener('click', openAddProjectModal);
            document.getElementById('calculateBtn').addEventListener('click', () => {
                const materials = getMaterialInputs();
                const values = {};
                materials.forEach(m => {
                    values[m.needed.id] = parseInt(m.needed.value) || 0;
                    values[m.have.id] = parseInt(m.have.value) || 0;
                });

                const resultsContainer = document.getElementById('results-container');
                const placeholder = document.getElementById('results-placeholder');
                let hasAnyResults = false;
                
                resultsContainer.querySelectorAll('div[id$="Result"]').forEach(div => {
                    div.innerHTML = '';
                    div.classList.add('hidden');
                });

                const processMaterial = (name, neededId, haveId) => {
                    const totalNeeded = values[neededId];
                    const camelCaseName = nameToCamelCase(name);
                    const resultDivId = `${camelCaseName}Result`;
                    const resultDiv = document.getElementById(resultDivId);

                    if (!resultDiv) {
                        console.error(`Could not find result div with ID: ${resultDivId}`);
                        return;
                    }

                    if (totalNeeded > 0) {
                        hasAnyResults = true;
                        const totalHave = values[haveId];
                        const netRequired = Math.max(0, totalNeeded - totalHave);
                        const calcResult = name !== "Chiral Crystals" ? calculateUnits(netRequired, unitSizes[camelCaseName]) : null;
                        resultDiv.innerHTML = formatResults(name, totalNeeded, totalHave, netRequired, calcResult);
                        resultDiv.classList.remove('hidden');
                    } else {
                        resultDiv.classList.add('hidden');
                    }
                };
                
                processMaterial("Resins", "resinsNeeded", "resinsHave");
                processMaterial("Metals", "metalsNeeded", "metalsHave");
                processMaterial("Ceramics", "ceramicsNeeded", "ceramicsHave");
                processMaterial("Chemicals", "chemicalsNeeded", "chemicalsHave");
                processMaterial("Special Alloys", "specialAlloysNeeded", "specialAlloysHave");
                processMaterial("Chiral Crystals", "chiralCrystalsNeeded", "chiralCrystalsHave");

                if (hasAnyResults) {
                    placeholder.classList.add('hidden');
                    resultsContainer.classList.remove('hidden');
                    resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    placeholder.classList.remove('hidden');
                    resultsContainer.classList.add('hidden');
                    if (Object.values(values).every(v => v === 0)) {
                        showModalMessage("Please enter an amount for at least one material.");
                    }
                }
            });

            document.getElementById('resetBtn').addEventListener('click', resetCalculator);

            document.querySelectorAll('.plus-btn').forEach(btn => {
                btn.addEventListener('click', () => openAddAmountModal(btn.dataset.targetInput));
            });

            getMaterialInputs().forEach(material => {
                material.needed.addEventListener('input', saveCurrentProjectNeeds);
                material.have.addEventListener('input', saveInventory);
            });
        });
    </script>
</body>
</html>
