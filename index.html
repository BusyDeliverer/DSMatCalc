<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Unit Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        kbd {
            background-color: #eee;
            border-radius: 3px;
            border: 1px solid #b4b4b4;
            box-shadow: 0 1px 1px rgba(0, 0, 0, .2), 0 2px 0 0 rgba(255, 255, 255, .7) inset;
            color: #333;
            display: inline-block;
            font-family: monospace;
            font-size: .8em;
            font-weight: 700;
            padding: 2px 4px;
            white-space: nowrap;
            margin: 0 2px;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl border border-gray-200">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Material Unit Calculator</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Resins Inputs -->
            <div class="flex flex-col">
                <label for="resinsNeeded" class="text-lg font-medium text-gray-700 mb-2">Total Resins Needed:</label>
                <div class="flex items-center gap-2 mb-2">
                    <input type="number" id="resinsNeeded" placeholder="e.g., 200" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                    <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="resinsNeeded">
                        +
                    </button>
                </div>
                <label for="resinsHave" class="text-lg font-medium text-gray-700 mb-2">Resins You Have:</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="resinsHave" placeholder="e.g., 50" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                    <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="resinsHave">
                        +
                    </button>
                </div>
            </div>

            <!-- Metals Inputs -->
            <div class="flex flex-col">
                <label for="metalsNeeded" class="text-lg font-medium text-gray-700 mb-2">Total Metals Needed:</label>
                <div class="flex items-center gap-2 mb-2">
                    <input type="number" id="metalsNeeded" placeholder="e.g., 550" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                    <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="metalsNeeded">
                        +
                    </button>
                </div>
                <label for="metalsHave" class="text-lg font-medium text-gray-700 mb-2">Metals You Have:</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="metalsHave" placeholder="e.g., 100" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                    <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="metalsHave">
                        +
                    </button>
                </div>
            </div>

            <!-- Ceramics Inputs -->
            <div class="flex flex-col">
                <label for="ceramicsNeeded" class="text-lg font-medium text-gray-700 mb-2">Total Ceramics Needed:</label>
                <div class="flex items-center gap-2 mb-2">
                    <input type="number" id="ceramicsNeeded" placeholder="e.g., 350" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                    <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="ceramicsNeeded">
                        +
                    </button>
                </div>
                <label for="ceramicsHave" class="text-lg font-medium text-gray-700 mb-2">Ceramics You Have:</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="ceramicsHave" placeholder="e.g., 80" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                    <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="ceramicsHave">
                        +
                    </button>
                </div>
            </div>

            <!-- Chemicals Inputs -->
            <div class="flex flex-col">
                <label for="chemicalsNeeded" class="text-lg font-medium text-gray-700 mb-2">Total Chemicals Needed:</label>
                <div class="flex items-center gap-2 mb-2">
                    <input type="number" id="chemicalsNeeded" placeholder="e.g., 180" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                    <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="chemicalsNeeded">
                        +
                    </button>
                </div>
                <label for="chemicalsHave" class="text-lg font-medium text-gray-700 mb-2">Chemicals You Have:</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="chemicalsHave" placeholder="e.g., 30" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                    <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="chemicalsHave">
                        +
                    </button>
                </div>
            </div>

            <!-- Special Alloys Inputs -->
            <div class="flex flex-col">
                <label for="specialAlloysNeeded" class="text-lg font-medium text-gray-700 mb-2">Total Special Alloys Needed:</label>
                <div class="flex items-center gap-2 mb-2">
                    <input type="number" id="specialAlloysNeeded" placeholder="e.g., 700" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                    <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="specialAlloysNeeded">
                        +
                    </button>
                </div>
                <label for="specialAlloysHave" class="text-lg font-medium text-gray-700 mb-2">Special Alloys You Have:</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="specialAlloysHave" placeholder="e.g., 120" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                    <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="specialAlloysHave">
                        +
                    </button>
                </div>
            </div>

            <!-- Chiral Crystals Inputs -->
            <div class="flex flex-col">
                <label for="chiralCrystalsNeeded" class="text-lg font-medium text-gray-700 mb-2">Total Chiral Crystals Needed:</label>
                <div class="flex items-center gap-2 mb-2">
                    <input type="number" id="chiralCrystalsNeeded" placeholder="e.g., 100" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                    <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="chiralCrystalsNeeded">
                        +
                    </button>
                </div>
                <label for="chiralCrystalsHave" class="text-lg font-medium text-gray-700 mb-2">Chiral Crystals You Have:</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="chiralCrystalsHave" placeholder="e.g., 20" class="p-3 border border-gray-300 rounded-lg flex-grow focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" min="0">
                    <button class="plus-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" data-target-input="chiralCrystalsHave">
                        +
                    </button>
                </div>
            </div>
        </div>

        <button id="calculateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
            Calculate Units
        </button>

        <!-- Placeholder for results when no results are shown -->
        <div id="results-placeholder" class="mt-8 p-4 bg-gray-100 rounded-lg border border-gray-200 text-center text-gray-500 italic hidden">
            Enter amounts and click "Calculate Units" to see the breakdown.
        </div>

        <!-- Redesigned results section - two-column layout -->
        <div id="results-container" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="resinsResult" class="bg-blue-50 p-4 rounded-lg border border-blue-200 hidden"></div>
            <div id="metalsResult" class="bg-green-50 p-4 rounded-lg border border-green-200 hidden"></div>
            <div id="ceramicsResult" class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 hidden"></div>
            <div id="chemicalsResult" class="bg-purple-50 p-4 rounded-lg border border-purple-200 hidden"></div>
            <div id="specialAlloysResult" class="bg-red-50 p-4 rounded-lg border border-red-200 hidden"></div>
            <div id="chiralCrystalsResult" class="bg-gray-50 p-4 rounded-lg border border-gray-200 hidden"></div>
        </div>

        <!-- New Finished Button -->
        <button id="finishedBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg mt-4 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
            Project Finished
        </button>

        <button id="resetBtn" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-xl shadow-lg mt-4 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-75">
            Reset All
        </button>

        <!-- Keyboard Shortcuts Text Below Buttons -->
        <div class="text-center text-gray-600 text-sm mt-4">
            <p>Shortcuts:
                <kbd>Enter</kbd> (Add Dialog: Save)
                <kbd>Esc</kbd> (Add Dialog: Cancel)
                <kbd>R</kbd> (Reset All)
            </p>
        </div>

        <!-- Custom Modal for Messages (like "Please enter an amount") -->
        <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <p id="modalMessage" class="text-gray-800 text-lg mb-4"></p>
                <button id="modalCloseBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">OK</button>
            </div>
        </div>

        <!-- Add Amount Modal - Simplified for direct addition -->
        <div id="addAmountModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Add Amount</h3>
                <input type="number" id="amountToAddInput" placeholder="Enter amount to add" class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent" min="0">
                <div class="flex justify-end gap-2">
                    <button id="cancelAddAmountBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md">Cancel</button>
                    <button id="confirmAddAmountBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Add</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal for Project Finished -->
        <div id="confirmFinishedModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <p class="text-gray-800 text-lg mb-4">Are you sure you want to mark this project as finished? This will reset "Total Needed" and adjust "You Have" amounts.</p>
                <div class="flex justify-center gap-4">
                    <button id="confirmFinishedYesBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">Yes, Finished</button>
                    <button id="confirmFinishedNoBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md">No, Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Function to display messages in a custom modal instead of alert()
        function showModalMessage(message) {
            const modal = document.getElementById('messageModal');
            const modalMessage = document.getElementById('modalMessage');
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            document.getElementById('modalCloseBtn').onclick = () => {
                modal.classList.add('hidden');
            };
        }

        // Define unit sizes for each material type (already sorted descending)
        const unitSizes = {
            resins: [320, 160, 80, 40],
            metals: [400, 200, 100, 50],
            ceramics: [320, 160, 80, 40],
            chemicals: [240, 120, 60, 30],
            specialAlloys: [480, 240, 120, 60]
        };

        // Function to calculate units for a given material, ensuring total is met or exceeded
        function calculateUnits(totalAmount, sizes) {
            let currentTotalProvided = 0;
            const unitsBreakdown = {};
            let wasted = 0;

            // Iterate through sizes from largest to smallest to fulfill the totalAmount
            for (const size of sizes) {
                if (size > 0 && currentTotalProvided < totalAmount) {
                    const count = Math.floor((totalAmount - currentTotalProvided) / size);
                    if (count > 0) {
                        unitsBreakdown[size] = (unitsBreakdown[size] || 0) + count;
                        currentTotalProvided += count * size;
                    }
                }
            }

            // If we still haven't met the totalAmount, add one unit of the smallest size
            if (currentTotalProvided < totalAmount) {
                const smallestSize = sizes[sizes.length - 1]; // Smallest unit is the last one in the pre-sorted array
                if (smallestSize > 0) {
                    unitsBreakdown[smallestSize] = (unitsBreakdown[smallestSize] || 0) + 1;
                    currentTotalProvided += smallestSize;
                }
            }

            // Calculate the wasted amount (if any)
            wasted = currentTotalProvided - totalAmount;
            if (wasted < 0) { // Should not ideally happen with the current logic
                wasted = 0;
            }

            return { units: unitsBreakdown, wasted: wasted, totalProvided: currentTotalProvided };
        }

        // Function to format the results for display
        function formatResults(materialDisplayName, totalNeeded, totalHave, netRequired, calcResult) {
            // Map display names to the actual keys in unitSizes to ensure correct lookup
            const keyMap = {
                "Resins": "resins",
                "Metals": "metals",
                "Ceramics": "ceramics",
                "Chemicals": "chemicals",
                "Special Alloys": "specialAlloys"
            };
            const materialKey = keyMap[materialDisplayName]; // Get the correct key

            let output = `<p class="text-lg font-semibold text-gray-800">${materialDisplayName}:</p>`;
            output += `<p class="text-gray-700 ml-4">Total Needed: ${totalNeeded}</p>`;
            output += `<p class="text-gray-700 ml-4">You Have: ${totalHave}</p>`;
            output += `<p class="text-blue-700 ml-4 font-semibold">Net Required: ${netRequired}</p>`;


            // Special handling for Chiral Crystals as they don't have unit breakdowns
            if (materialDisplayName === "Chiral Crystals") {
                // No unit breakdown or wasted for Chiral Crystals
            } else {
                let hasUnits = false;
                if (!materialKey || !unitSizes[materialKey]) {
                    console.error(`Invalid material name or missing unit sizes: ${materialDisplayName}`);
                    output += `<p class="text-red-600">Error: Could not retrieve unit sizes for breakdown.</p>`;
                } else {
                    output += `<p class="text-md font-semibold text-gray-800 ml-4">Unit Breakdown (for Net Required):</p>`;
                    const sizesForMaterial = unitSizes[materialKey];
                    for (const size of sizesForMaterial) {
                        const count = calcResult.units[size] || 0;
                        if (count > 0) {
                            output += `<p class="text-gray-700 ml-8">${count} x ${size} units</p>`;
                            hasUnits = true;
                        }
                    }
                    if (!hasUnits && netRequired > 0) {
                        output += `<p class="text-gray-700 ml-8">No units needed (or net required is 0).</p>`;
                    } else if (!hasUnits && netRequired === 0) {
                         output += `<p class="text-gray-700 ml-8">Net required is 0, no units needed.</p>`;
                    }
                }

                // Display wasted amount if greater than zero
                if (calcResult && calcResult.wasted > 0) {
                    output += `<p class="text-red-600 ml-4 font-semibold">Wasted: ${calcResult.wasted} units (total provided exceeds required amount for Net Required).</p>`;
                }
            }
            return output;
        }

        // Helper function to get all input elements for materials
        function getMaterialInputs() {
            return [
                { needed: document.getElementById('resinsNeeded'), have: document.getElementById('resinsHave') },
                { needed: document.getElementById('metalsNeeded'), have: document.getElementById('metalsHave') },
                { needed: document.getElementById('ceramicsNeeded'), have: document.getElementById('ceramicsHave') },
                { needed: document.getElementById('chemicalsNeeded'), have: document.getElementById('chemicalsHave') },
                { needed: document.getElementById('specialAlloysNeeded'), have: document.getElementById('specialAlloysHave') },
                { needed: document.getElementById('chiralCrystalsNeeded'), have: document.getElementById('chiralCrystalsHave') }
            ];
        }

        // Function to save current inventory to local storage
        function saveInventory() {
            const inventory = {};
            getMaterialInputs().forEach(material => {
                inventory[material.needed.id] = parseInt(material.needed.value) || 0;
                inventory[material.have.id] = parseInt(material.have.value) || 0;
            });
            localStorage.setItem('materialInventory', JSON.stringify(inventory));
        }

        // Function to load inventory from local storage
        function loadInventory() {
            const savedInventory = localStorage.getItem('materialInventory');
            if (savedInventory) {
                const inventory = JSON.parse(savedInventory);
                getMaterialInputs().forEach(material => {
                    if (inventory[material.needed.id] !== undefined) {
                        material.needed.value = inventory[material.needed.id];
                    }
                    if (inventory[material.have.id] !== undefined) {
                        material.have.value = inventory[material.have.id];
                    }
                });
            }
        }


        // Function to reset all inputs and results
        function resetCalculator() {
            // Only reset 'needed' fields
            document.getElementById('resinsNeeded').value = '';
            document.getElementById('metalsNeeded').value = '';
            document.getElementById('ceramicsNeeded').value = '';
            document.getElementById('chemicalsNeeded').value = '';
            document.getElementById('specialAlloysNeeded').value = '';
            document.getElementById('chiralCrystalsNeeded').value = '';

            const resultDivs = [
                document.getElementById('resinsResult'),
                document.getElementById('metalsResult'),
                document.getElementById('ceramicsResult'),
                document.getElementById('chemicalsResult'),
                document.getElementById('specialAlloysResult'),
                document.getElementById('chiralCrystalsResult')
            ];

            resultDivs.forEach(div => {
                div.innerHTML = ''; // Clear content
                div.classList.add('hidden'); // Hide the div
            });

            // Show placeholder when results are cleared
            document.getElementById('results-placeholder').classList.remove('hidden');
            saveInventory(); // Save changes to local storage
        }

        // --- Modal for adding amount ---
        const addAmountModal = document.getElementById('addAmountModal');
        const amountToAddInput = document.getElementById('amountToAddInput');
        const confirmAddAmountBtn = document.getElementById('confirmAddAmountBtn');
        const cancelAddAmountBtn = document.getElementById('cancelAddAmountBtn');
        let currentTargetInputId = null; // To keep track of which input field the modal is for

        // Function to open the add amount modal
        function openAddAmountModal(targetInputId) {
            currentTargetInputId = targetInputId;
            amountToAddInput.value = ''; // Clear previous input
            addAmountModal.classList.remove('hidden');
            amountToAddInput.focus();
        }

        // Function to close the add amount modal
        function closeAddAmountModal() {
            addAmountModal.classList.add('hidden');
            currentTargetInputId = null;
        }

        // Event listener for confirming amount addition
        confirmAddAmountBtn.addEventListener('click', () => {
            if (currentTargetInputId) {
                const amount = parseInt(amountToAddInput.value) || 0;
                const targetInput = document.getElementById(currentTargetInputId);
                const currentValue = parseInt(targetInput.value) || 0;
                targetInput.value = currentValue + amount;
                saveInventory(); // Save changes to local storage
            }
            closeAddAmountModal();
        });

        // Event listener for canceling amount addition
        cancelAddAmountBtn.addEventListener('click', closeAddAmountModal);

        // Event listeners for all plus buttons
        document.querySelectorAll('.plus-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const targetInputId = event.target.dataset.targetInput;
                openAddAmountModal(targetInputId);
            });
        });

        // Add input event listeners to all needed and have fields for immediate saving
        getMaterialInputs().forEach(material => {
            material.needed.addEventListener('input', saveInventory);
            material.have.addEventListener('input', saveInventory);
        });


        // Keyboard shortcuts for the add amount modal
        amountToAddInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                confirmAddAmountBtn.click();
            }
        });

        addAmountModal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                event.preventDefault();
                cancelAddAmountBtn.click();
            }
        });

        // --- Confirmation Modal for Project Finished ---
        const confirmFinishedModal = document.getElementById('confirmFinishedModal');
        const confirmFinishedYesBtn = document.getElementById('confirmFinishedYesBtn');
        const confirmFinishedNoBtn = document.getElementById('confirmFinishedNoBtn');

        // Function to open confirmation modal
        function openConfirmFinishedModal() {
            confirmFinishedModal.classList.remove('hidden');
        }

        // Function to close confirmation modal
        function closeConfirmFinishedModal() {
            confirmFinishedModal.classList.add('hidden');
        }

        // Event listener for the new "Project Finished" button
        document.getElementById('finishedBtn').addEventListener('click', openConfirmFinishedModal);

        // Event listener for "Yes, Finished" in confirmation modal
        confirmFinishedYesBtn.addEventListener('click', () => {
            const materials = getMaterialInputs();

            materials.forEach(material => {
                const neededInput = material.needed;
                const haveInput = material.have;

                const currentNeeded = parseInt(neededInput.value) || 0;
                const currentHave = parseInt(haveInput.value) || 0;

                // Subtract the total needed amount from 'You Have', ensuring it doesn't go below 0
                haveInput.value = Math.max(0, currentHave - currentNeeded);

                // Reset 'Total Needed' to 0
                neededInput.value = 0;
            });

            // After updating inputs, clear results and show placeholder
            const resultDivs = [
                document.getElementById('resinsResult'),
                document.getElementById('metalsResult'),
                document.getElementById('ceramicsResult'),
                document.getElementById('chemicalsResult'),
                document.getElementById('specialAlloysResult'),
                document.getElementById('chiralCrystalsResult')
            ];
            resultDivs.forEach(div => {
                div.innerHTML = '';
                div.classList.add('hidden');
            });
            document.getElementById('results-placeholder').classList.remove('hidden');
            saveInventory(); // Save changes to local storage
            closeConfirmFinishedModal(); // Close the confirmation modal
        });

        // Event listener for "No, Cancel" in confirmation modal
        confirmFinishedNoBtn.addEventListener('click', closeConfirmFinishedModal);


        // Keyboard shortcut for reset (pressing 'R')
        document.addEventListener('keydown', (event) => {
            if (event.key.toLowerCase() === 'r' && addAmountModal.classList.contains('hidden') && messageModal.classList.contains('hidden') && confirmFinishedModal.classList.contains('hidden')) {
                event.preventDefault();
                resetCalculator();
            }
        });


        // Main calculation function
        document.getElementById('calculateBtn').addEventListener('click', () => {
            // Get "Needed" and "Have" values for all materials
            const resinsNeeded = parseInt(document.getElementById('resinsNeeded').value) || 0;
            const resinsHave = parseInt(document.getElementById('resinsHave').value) || 0;
            const metalsNeeded = parseInt(document.getElementById('metalsNeeded').value) || 0;
            const metalsHave = parseInt(document.getElementById('metalsHave').value) || 0;
            const ceramicsNeeded = parseInt(document.getElementById('ceramicsNeeded').value) || 0;
            const ceramicsHave = parseInt(document.getElementById('ceramicsHave').value) || 0;
            const chemicalsNeeded = parseInt(document.getElementById('chemicalsNeeded').value) || 0;
            const chemicalsHave = parseInt(document.getElementById('chemicalsHave').value) || 0;
            const specialAlloysNeeded = parseInt(document.getElementById('specialAlloysNeeded').value) || 0;
            const specialAlloysHave = parseInt(document.getElementById('specialAlloysHave').value) || 0;
            const chiralCrystalsNeeded = parseInt(document.getElementById('chiralCrystalsNeeded').value) || 0;
            const chiralCrystalsHave = parseInt(document.getElementById('chiralCrystalsHave').value) || 0;

            // Calculate Net Required
            const netResins = Math.max(0, resinsNeeded - resinsHave);
            const netMetals = Math.max(0, metalsNeeded - metalsHave);
            const netCeramics = Math.max(0, ceramicsNeeded - ceramicsHave);
            const netChemicals = Math.max(0, chemicalsNeeded - chemicalsHave);
            const netSpecialAlloys = Math.max(0, specialAlloysNeeded - specialAlloysHave);
            const netChiralCrystals = Math.max(0, chiralCrystalsNeeded - chiralCrystalsHave);

            // Get result display elements
            const resinsResultDiv = document.getElementById('resinsResult');
            const metalsResultDiv = document.getElementById('metalsResult');
            const ceramicsResultDiv = document.getElementById('ceramicsResult');
            const chemicalsResultDiv = document.getElementById('chemicalsResult');
            const specialAlloysResultDiv = document.getElementById('specialAlloysResult');
            const chiralCrystalsResultDiv = document.getElementById('chiralCrystalsResult');

            // Hide all results initially
            [resinsResultDiv, metalsResultDiv, ceramicsResultDiv, chemicalsResultDiv, specialAlloysResultDiv, chiralCrystalsResultDiv].forEach(div => div.classList.add('hidden'));

            let hasAnyResults = false; // Flag to track if any results are displayed

            // Perform calculations and display results for each material if net required > 0 or total needed > 0
            if (netResins > 0 || resinsNeeded > 0) { // Display if needed or net required
                const resinsCalc = calculateUnits(netResins, unitSizes.resins);
                resinsResultDiv.innerHTML = formatResults("Resins", resinsNeeded, resinsHave, netResins, resinsCalc);
                resinsResultDiv.classList.remove('hidden');
                hasAnyResults = true;
            }
            if (netMetals > 0 || metalsNeeded > 0) {
                const metalsCalc = calculateUnits(netMetals, unitSizes.metals);
                metalsResultDiv.innerHTML = formatResults("Metals", metalsNeeded, metalsHave, netMetals, metalsCalc);
                metalsResultDiv.classList.remove('hidden');
                hasAnyResults = true;
            }
            if (netCeramics > 0 || ceramicsNeeded > 0) {
                const ceramicsCalc = calculateUnits(netCeramics, unitSizes.ceramics);
                ceramicsResultDiv.innerHTML = formatResults("Ceramics", ceramicsNeeded, ceramicsHave, netCeramics, ceramicsCalc);
                ceramicsResultDiv.classList.remove('hidden');
                hasAnyResults = true;
            }
            if (netChemicals > 0 || chemicalsNeeded > 0) {
                const chemicalsCalc = calculateUnits(netChemicals, unitSizes.chemicals);
                chemicalsResultDiv.innerHTML = formatResults("Chemicals", chemicalsNeeded, chemicalsHave, netChemicals, chemicalsCalc);
                chemicalsResultDiv.classList.remove('hidden');
                hasAnyResults = true;
            }
            if (netSpecialAlloys > 0 || specialAlloysNeeded > 0) {
                const specialAlloysCalc = calculateUnits(netSpecialAlloys, unitSizes.specialAlloys);
                specialAlloysResultDiv.innerHTML = formatResults("Special Alloys", specialAlloysNeeded, specialAlloysHave, netSpecialAlloys, specialAlloysCalc);
                specialAlloysResultDiv.classList.remove('hidden');
                hasAnyResults = true;
            }
            // Chiral Crystals do not have units, so pass null for calcResult
            if (netChiralCrystals > 0 || chiralCrystalsNeeded > 0) {
                chiralCrystalsResultDiv.innerHTML = formatResults("Chiral Crystals", chiralCrystalsNeeded, chiralCrystalsHave, netChiralCrystals, null);
                chiralCrystalsResultDiv.classList.remove('hidden');
                hasAnyResults = true;
            }

            // Hide placeholder if results are being shown, otherwise show it if no results
            if (hasAnyResults) {
                document.getElementById('results-placeholder').classList.add('hidden');
            } else {
                document.getElementById('results-placeholder').classList.remove('hidden');
                // Only show message if ALL needed inputs are zero and no results are shown
                if (resinsNeeded === 0 && metalsNeeded === 0 && ceramicsNeeded === 0 && chemicalsNeeded === 0 && specialAlloysNeeded === 0 && chiralCrystalsNeeded === 0) {
                    showModalMessage("Please enter an amount for at least one material to calculate units.");
                }
            }

            // Scroll to the results container after calculation
            document.getElementById('results-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        // Event listener for the reset button
        document.getElementById('resetBtn').addEventListener('click', resetCalculator);

        // Initially show the placeholder on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadInventory(); // Load inventory when the page loads
            document.getElementById('results-placeholder').classList.remove('hidden');
        });
    </script>
</body>
</html>
